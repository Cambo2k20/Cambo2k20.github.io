<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trivia Hero</title>

  <!-- React 18 + ReactDOM + Babel (for JSX in-browser) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root { height: 100%; }
    .no-select { user-select: none; -webkit-user-select: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 text-white antialiased no-select">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    /*******************
     * HELPERS
     *******************/
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function levenshtein(a, b) {
      a = a.toLowerCase().trim();
      b = b.toLowerCase().trim();
      const m = a.length, n = b.length;
      const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      return dp[m][n];
    }
    function similarity(a, b) {
      if (!a || !b) return 0;
      const dist = levenshtein(a, b);
      return 1 - dist / Math.max(a.length, b.length);
    }

    function getFemaleVoice() {
      const synth = window.speechSynthesis;
      const voices = synth.getVoices();
      if (!voices || voices.length === 0) return null;
      const preferred = ["Samantha", "Victoria", "Google UK English Female", "Google US English", "Microsoft Zira"];
      return (
        voices.find(v => /female/i.test(v.name)) ||
        voices.find(v => preferred.some(p => v.name.includes(p))) ||
        voices.find(v => /English/i.test(v.lang)) ||
        voices[0]
      );
    }

    function speak(text, voiceRef) {
      if (!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      const voice = voiceRef.current || getFemaleVoice();
      if (voice) utter.voice = voice;
      window.speechSynthesis.speak(utter);
    }
    function stopSpeech() {
      if (window.speechSynthesis) window.speechSynthesis.cancel();
    }

    /*******************
     * LOAD QUESTIONS
     *******************/
    async function loadQuestions() {
      const categories = ["geography","history","science","entertainment","sports","literature","general"];
      let all = [];
      for (let cat of categories) {
        const res = await fetch(`Questions/${cat}.json`); // capital Q!
        const data = await res.json();
        all = all.concat(data);
      }
      return all;
    }

    function prepareQuestions(raw) {
      return raw.map(q => {
        const shuffledAnswers = shuffle(q.a);
        const correctIndex = shuffledAnswers.findIndex(x => x === q.answer);
        return { ...q, a: shuffledAnswers, correct: correctIndex };
      });
    }

    /*******************
     * APP
     *******************/
    const MODES = {
      CLASSIC: { key:"CLASSIC",label:"Classic 🎯",basePoints:100,duration:60,expert:false },
      EXPERT: { key:"EXPERT",label:"Expert ✍️",basePoints:150,duration:90,expert:true }
    };

    function useVoices() {
      const voiceRef = useRef(null);
      useEffect(() => {
        const setVoice = () => { voiceRef.current = getFemaleVoice(); };
        setVoice();
        if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = setVoice;
      }, []);
      return voiceRef;
    }

    function TriviaHero() {
      const [screen,setScreen]=useState("HOME");
      const [mode,setMode]=useState(MODES.CLASSIC);
      const [questions,setQuestions]=useState([]);
      const [qIndex,setQIndex]=useState(0);
      const [timeLeft,setTimeLeft]=useState(mode.duration);
      const [score,setScore]=useState(0);
      const [streak,setStreak]=useState(0);
      const [selected,setSelected]=useState(null);
      const [feedback,setFeedback]=useState(null);
      const [typed,setTyped]=useState("");

      const voiceRef=useVoices();
      const currentQuestion=questions[qIndex];

      const startGame=async()=>{
        stopSpeech();
        const raw=await loadQuestions();
        const prepped=prepareQuestions(raw);
        setQuestions(shuffle(prepped));
        setQIndex(0);
        setTimeLeft(mode.duration);
        setScore(0);
        setStreak(0);
        setSelected(null);
        setFeedback(null);
        setScreen("GAME");
      };

      const handleAnswer=(i)=>{
        if(selected!==null)return;
        setSelected(i);
        const isCorrect=i===currentQuestion.correct;
        setFeedback(isCorrect?"correct":"incorrect");
        if(isCorrect){
          const newStreak=streak+1;
          setStreak(newStreak);
          setScore(s=>s+mode.basePoints+50*newStreak);
        }else{
          setStreak(0);
        }
        setTimeout(()=>{setQIndex(qIndex+1);setSelected(null);setFeedback(null);},1500);
      };

      const submitTypedAnswer=()=>{
        if(feedback) return;
        const sim=similarity(typed,currentQuestion.answer);
        const isCorrect=sim>=0.8;
        setFeedback(isCorrect?"correct":"incorrect");
        if(isCorrect){
          const newStreak=streak+1;
          setStreak(newStreak);
          setScore(s=>s+mode.basePoints+50*newStreak);
        }else{
          setStreak(0);
        }
        setTimeout(()=>{setQIndex(qIndex+1);setFeedback(null);setTyped("");},2500);
      };

      const HomeScreen=()=>(
        <div className="flex items-center justify-center h-full">
          <div className="text-center space-y-4">
            <h1 className="text-4xl font-bold">Trivia Hero</h1>
            <button onClick={()=>setMode(MODES.CLASSIC)} className="px-4 py-2 bg-white/20 rounded">{MODES.CLASSIC.label}</button>
            <button onClick={()=>setMode(MODES.EXPERT)} className="px-4 py-2 bg-white/20 rounded">{MODES.EXPERT.label}</button>
            <div><button onClick={startGame} className="px-6 py-3 bg-white text-indigo-700 rounded">Start</button></div>
          </div>
        </div>
      );

      const GameScreen=()=>(
        <div className="flex items-center justify-center h-full p-4">
          <div className="max-w-2xl w-full bg-white/10 p-6 rounded-xl">
            <h2 className="text-xl mb-4">{currentQuestion?.q}</h2>
            {!mode.expert ? (
              <div className="grid grid-cols-2 gap-3">
                {currentQuestion?.a.map((opt,i)=>(
                  <button key={i}
                    onClick={()=>handleAnswer(i)}
                    className="p-3 rounded bg-white/20">{opt}</button>
                ))}
              </div>
            ):(
              <div className="flex gap-2">
                <input value={typed} onChange={e=>setTyped(e.target.value)} className="flex-1 p-2 text-black rounded"/>
                <button onClick={submitTypedAnswer} className="px-4 py-2 bg-white text-indigo-700 rounded">Submit</button>
              </div>
            )}
          </div>
        </div>
      );

      return (
        <div className="h-full">
          {screen==="HOME" && <HomeScreen/>}
          {screen==="GAME" && <GameScreen/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<TriviaHero/>);
  </script>
</body>
</html>
